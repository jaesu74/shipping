<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#000000">
    <meta name="description" content="해운 데이터 수집 및 모니터링 시스템 - 데이터 시각화">
    <link rel="icon" href="favicon.ico">
    <link rel="apple-touch-icon" href="logo192.png">
    <link rel="manifest" href="manifest.json">
    <title>해운 데이터 모니터링 - 데이터 시각화</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f5f5f5;
        }
        .navbar-brand {
            font-weight: 700;
        }
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            border: none;
        }
        .card-header {
            background-color: #fff;
            border-bottom: 1px solid #eee;
            font-weight: 600;
            padding: 0.75rem 1.25rem;
            border-radius: 10px 10px 0 0 !important;
        }
        .sidebar {
            position: fixed;
            top: 0;
            bottom: 0;
            left: 0;
            z-index: 100;
            padding: 48px 0 0;
            box-shadow: inset -1px 0 0 rgba(0, 0, 0, .1);
        }
        .sidebar-sticky {
            position: relative;
            top: 0;
            height: calc(100vh - 48px);
            padding-top: .5rem;
            overflow-x: hidden;
            overflow-y: auto;
        }
        .index-change-up {
            color: #dc3545;
        }
        .index-change-down {
            color: #198754;
        }
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        .data-card {
            transition: all 0.3s ease;
        }
        .data-card:hover {
            transform: translateY(-5px);
        }
    </style>
</head>
<body>
    <header class="navbar navbar-dark sticky-top bg-dark flex-md-nowrap p-0 shadow">
        <a class="navbar-brand col-md-3 col-lg-2 me-0 px-3" href="#"><i class="bi bi-ship"></i> 해운 데이터 모니터링</a>
        <button class="navbar-toggler position-absolute d-md-none collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#sidebarMenu" aria-controls="sidebarMenu" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="navbar-nav">
            <div class="nav-item text-nowrap">
                <a class="nav-link px-3" href="#" id="logoutBtn">로그아웃</a>
            </div>
        </div>
    </header>
    
    <div class="container-fluid">
        <div class="row">
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
                <div class="position-sticky pt-3 sidebar-sticky">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="dashboard.html">
                                <i class="bi bi-speedometer2 me-2"></i>
                                대시보드
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="dashboard.html?category=baltic">
                                <i class="bi bi-bar-chart-line me-2"></i>
                                Baltic Exchange 지수
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="dashboard.html?category=container">
                                <i class="bi bi-box-seam me-2"></i>
                                컨테이너 운임
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="dashboard.html?category=bunker">
                                <i class="bi bi-fuel-pump me-2"></i>
                                벙커유 가격
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="dashboard.html?category=port">
                                <i class="bi bi-geo-alt me-2"></i>
                                항만 혼잡도
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="all-indices.html">
                                <i class="bi bi-grid-3x3-gap me-2"></i>
                                전체 지수
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="data-visualization.html">
                                <i class="bi bi-graph-up me-2"></i>
                                데이터 시각화
                            </a>
                        </li>
                    </ul>
                    
                    <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
                        <span>데이터 관리</span>
                    </h6>
                    <ul class="nav flex-column mb-2">
                        <li class="nav-item">
                            <a class="nav-link" href="#" id="collectDataBtn">
                                <i class="bi bi-cloud-download me-2"></i>
                                데이터 수집
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" id="exportImageBtn">
                                <i class="bi bi-image me-2"></i>
                                이미지 내보내기
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>
            
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">해운 데이터 시각화</h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <div class="btn-group me-2">
                            <span class="btn btn-sm btn-outline-secondary" id="lastUpdated">최종 업데이트: 로딩 중...</span>
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-primary" id="refreshBtn">
                            <i class="bi bi-arrow-repeat"></i>
                            새로고침
                        </button>
                    </div>
                </div>
                
                <!-- 상태 알림 -->
                <div class="alert alert-info alert-dismissible fade show" role="alert" id="statusAlert" style="display: none;">
                    <span id="statusMessage"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                
                <!-- 대시보드 메트릭스 -->
                <div class="row g-3 mb-4">
                    <div class="col-md-3">
                        <div class="card bg-light data-card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="card-title text-muted">BDI</h6>
                                        <h4 class="mb-2" id="bdiValue">로딩 중...</h4>
                                        <span class="badge bg-primary">Baltic Exchange</span>
                                    </div>
                                    <div class="text-end">
                                        <span class="index-change" id="bdiChange">-</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-light data-card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="card-title text-muted">SCFI</h6>
                                        <h4 class="mb-2" id="scfiValue">로딩 중...</h4>
                                        <span class="badge bg-info">SCFI</span>
                                    </div>
                                    <div class="text-end">
                                        <span class="index-change" id="scfiChange">-</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-light data-card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="card-title text-muted">벙커유 (VLSFO)</h6>
                                        <h4 class="mb-2" id="bunkerValue">로딩 중...</h4>
                                        <span class="badge bg-warning text-dark">Ship & Bunker</span>
                                    </div>
                                    <div class="text-end">
                                        <span class="index-change" id="bunkerChange">-</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-light data-card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="card-title text-muted">FBX 글로벌</h6>
                                        <h4 class="mb-2" id="fbxValue">로딩 중...</h4>
                                        <span class="badge bg-success">FBX</span>
                                    </div>
                                    <div class="text-end">
                                        <span class="index-change" id="fbxChange">-</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 차트 카테고리 선택 -->
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="btn-group btn-group-sm" role="group" aria-label="차트 카테고리">
                            <button type="button" class="btn btn-outline-primary active" data-chart="baltic">Baltic</button>
                            <button type="button" class="btn btn-outline-primary" data-chart="container">컨테이너</button>
                            <button type="button" class="btn btn-outline-primary" data-chart="bunker">벙커유</button>
                            <button type="button" class="btn btn-outline-primary" data-chart="port">항만</button>
                            <button type="button" class="btn btn-outline-primary" data-chart="compare">비교</button>
                        </div>
                    </div>
                </div>
                
                <!-- 차트 영역 -->
                <div class="row mb-4">
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <span id="chartTitle">Baltic Exchange 지수</span>
                                <div class="btn-group">
                                    <button type="button" class="btn btn-sm btn-outline-secondary active" data-period="week">주간</button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" data-period="month">월간</button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" data-period="year">연간</button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="mainChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <span>지수 분포</span>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="pieChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 토큰 확인
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = 'index.html';
                return;
            }
            
            // API 요청 헤더
            const headers = {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            };
            
            // 전역 변수
            let allIndices = [];
            let chartData = {};
            let mainChart = null;
            let pieChart = null;
            let currentChartType = 'baltic';
            let currentPeriod = 'week';
            
            // 데이터 로드
            async function loadData() {
                try {
                    showAlert('데이터를 불러오는 중입니다...', 'info');
                    
                    const response = await fetch('/api/shipping/latest', {
                        headers
                    });
                    
                    if (response.status === 401 || response.status === 403) {
                        localStorage.removeItem('token');
                        window.location.href = 'index.html';
                        return;
                    }
                    
                    if (!response.ok) {
                        throw new Error('데이터를 불러오는데 실패했습니다');
                    }
                    
                    const data = await response.json();
                    document.getElementById('lastUpdated').textContent = `최종 업데이트: ${new Date(data.date).toLocaleString()}`;
                    
                    // 인덱스 데이터 처리
                    allIndices = data.indices.map((index, i) => {
                        // 변동폭에서 숫자 추출
                        let changeNum = 0;
                        if (index.change) {
                            const match = index.change.match(/-?\d+(\.\d+)?/);
                            if (match) {
                                changeNum = parseFloat(match[0]);
                            }
                        }
                        
                        // 변동률 계산 (임의의 값)
                        let changePercent = 0;
                        if (index.change) {
                            // 부호에 따라 임의의 변동률 범위 설정
                            if (index.change.startsWith('+')) {
                                changePercent = (Math.random() * 5).toFixed(2);
                            } else if (index.change.startsWith('-')) {
                                changePercent = (-Math.random() * 5).toFixed(2);
                            }
                        }
                        
                        // 지수 유형 분류
                        let category = '';
                        if (index.source === 'Baltic Exchange') {
                            category = 'baltic';
                        } else if (index.source === '상하이 컨테이너 운임 지수') {
                            category = 'scfi';
                        } else if (index.source === 'Ship & Bunker') {
                            category = 'bunker';
                        } else if (index.source === 'Freightos Baltic Index' || index.source === 'Drewry WCI') {
                            category = 'container';
                        } else if (index.source === '글로벌 항만 혼잡도 지수') {
                            category = 'port';
                        }
                        
                        return {
                            id: i,
                            name: index.name,
                            value: index.value,
                            numericValue: parseFloat(index.value.replace(/[^0-9.-]+/g, '')) || 0,
                            change: index.change || '0',
                            changeNum: changeNum,
                            changePercent: changePercent,
                            source: index.source,
                            date: data.date,
                            category: category
                        };
                    });
                    
                    // 주요 지표 업데이트
                    updateKeyMetrics();
                    
                    // 차트 데이터 준비
                    prepareChartData();
                    
                    // 차트 렌더링
                    updateCharts();
                    
                    hideAlert();
                } catch (error) {
                    showAlert('오류: ' + error.message, 'danger');
                    console.error('데이터 로드 오류:', error);
                }
            }
            
            // 주요 지표 업데이트
            function updateKeyMetrics() {
                // BDI
                const bdi = allIndices.find(index => index.name === 'BDI (Baltic Dry Index)');
                if (bdi) {
                    document.getElementById('bdiValue').textContent = bdi.value;
                    const bdiChangeEl = document.getElementById('bdiChange');
                    bdiChangeEl.textContent = bdi.change;
                    if (bdi.change.startsWith('+')) {
                        bdiChangeEl.className = 'index-change index-change-up';
                    } else if (bdi.change.startsWith('-')) {
                        bdiChangeEl.className = 'index-change index-change-down';
                    }
                }
                
                // SCFI
                const scfi = allIndices.find(index => index.name === 'SCFI 종합지수');
                if (scfi) {
                    document.getElementById('scfiValue').textContent = scfi.value;
                    const scfiChangeEl = document.getElementById('scfiChange');
                    scfiChangeEl.textContent = scfi.change;
                    if (scfi.change.startsWith('+')) {
                        scfiChangeEl.className = 'index-change index-change-up';
                    } else if (scfi.change.startsWith('-')) {
                        scfiChangeEl.className = 'index-change index-change-down';
                    }
                }
                
                // Bunker
                const bunker = allIndices.find(index => index.name === '글로벌 평균 VLSFO');
                if (bunker) {
                    document.getElementById('bunkerValue').textContent = bunker.value;
                    const bunkerChangeEl = document.getElementById('bunkerChange');
                    bunkerChangeEl.textContent = bunker.change;
                    if (bunker.change.startsWith('+')) {
                        bunkerChangeEl.className = 'index-change index-change-up';
                    } else if (bunker.change.startsWith('-')) {
                        bunkerChangeEl.className = 'index-change index-change-down';
                    }
                }
                
                // FBX
                const fbx = allIndices.find(index => index.name === 'FBX 글로벌 컨테이너 운임');
                if (fbx) {
                    document.getElementById('fbxValue').textContent = fbx.value;
                    const fbxChangeEl = document.getElementById('fbxChange');
                    fbxChangeEl.textContent = fbx.change;
                    if (fbx.change.startsWith('+')) {
                        fbxChangeEl.className = 'index-change index-change-up';
                    } else if (fbx.change.startsWith('-')) {
                        fbxChangeEl.className = 'index-change index-change-down';
                    }
                }
            }
            
            // 차트 데이터 준비
            function prepareChartData() {
                // Baltic Exchange 지수 데이터
                const balticIndices = allIndices.filter(index => index.category === 'baltic');
                
                // 컨테이너 운임 데이터
                const containerIndices = allIndices.filter(index => index.category === 'container');
                
                // 벙커유 데이터
                const bunkerIndices = allIndices.filter(index => index.category === 'bunker');
                
                // 항만 혼잡도 데이터
                const portIndices = allIndices.filter(index => index.category === 'port');
                
                // 모의 기간 데이터 생성 (실제 구현에서는 API에서 기간별 데이터를 가져와야 함)
                const today = new Date();
                
                // 기간별 날짜 생성
                const generateDateRange = (period) => {
                    const dates = [];
                    const days = period === 'week' ? 7 : period === 'month' ? 30 : 365;
                    
                    for (let i = days - 1; i >= 0; i--) {
                        const date = new Date();
                        date.setDate(today.getDate() - i);
                        dates.push(date.toLocaleDateString());
                    }
                    
                    return dates;
                };
                
                // 임의의 기간 데이터 생성
                const generatePeriodData = (indices, period) => {
                    const data = {};
                    
                    indices.forEach(index => {
                        const baseValue = index.numericValue;
                        const values = [];
                        
                        const days = period === 'week' ? 7 : period === 'month' ? 30 : 365;
                        const volatility = period === 'week' ? 0.05 : period === 'month' ? 0.1 : 0.2;
                        
                        // 현재 값을 마지막으로 하는 시계열 데이터 생성
                        for (let i = 0; i < days - 1; i++) {
                            // 임의의 변동폭 생성
                            const change = baseValue * (Math.random() * volatility * 2 - volatility);
                            const prevValue = i === 0 ? baseValue * 0.85 : values[i - 1];
                            values.push(prevValue + change);
                        }
                        
                        // 마지막 값은 현재 값
                        values.push(baseValue);
                        
                        data[index.name] = values;
                    });
                    
                    return data;
                };
                
                // 차트 데이터 생성
                chartData = {
                    week: {
                        labels: generateDateRange('week'),
                        baltic: generatePeriodData(balticIndices, 'week'),
                        container: generatePeriodData(containerIndices, 'week'),
                        bunker: generatePeriodData(bunkerIndices, 'week'),
                        port: generatePeriodData(portIndices, 'week')
                    },
                    month: {
                        labels: generateDateRange('month'),
                        baltic: generatePeriodData(balticIndices, 'month'),
                        container: generatePeriodData(containerIndices, 'month'),
                        bunker: generatePeriodData(bunkerIndices, 'month'),
                        port: generatePeriodData(portIndices, 'month')
                    },
                    year: {
                        labels: generateDateRange('year'),
                        baltic: generatePeriodData(balticIndices, 'year'),
                        container: generatePeriodData(containerIndices, 'year'),
                        bunker: generatePeriodData(bunkerIndices, 'year'),
                        port: generatePeriodData(portIndices, 'year')
                    }
                };
            }
            
            // 메인 차트 업데이트
            function updateMainChart() {
                const chartTitle = document.getElementById('chartTitle');
                const canvas = document.getElementById('mainChart');
                const ctx = canvas.getContext('2d');
                
                // 기존 차트 제거
                if (mainChart) {
                    mainChart.destroy();
                }
                
                // 차트 타입에 따른 데이터 및 타이틀 설정
                let data = {};
                let chartTitleText = '';
                
                switch (currentChartType) {
                    case 'baltic':
                        data = chartData[currentPeriod].baltic;
                        chartTitleText = 'Baltic Exchange 지수';
                        break;
                    case 'container':
                        data = chartData[currentPeriod].container;
                        chartTitleText = '컨테이너 운임 지수';
                        break;
                    case 'bunker':
                        data = chartData[currentPeriod].bunker;
                        chartTitleText = '벙커유 가격';
                        break;
                    case 'port':
                        data = chartData[currentPeriod].port;
                        chartTitleText = '항만 혼잡도 지수';
                        break;
                    case 'compare':
                        // 비교 차트는 각 카테고리 대표 지수 하나씩 표시
                        const bdi = allIndices.find(index => index.name === 'BDI (Baltic Dry Index)');
                        const scfi = allIndices.find(index => index.name === 'SCFI 종합지수');
                        const bunker = allIndices.find(index => index.name === '글로벌 평균 VLSFO');
                        const fbx = allIndices.find(index => index.name === 'FBX 글로벌 컨테이너 운임');
                        
                        data = {
                            'BDI': chartData[currentPeriod].baltic[bdi.name],
                            'SCFI': chartData[currentPeriod].baltic[scfi.name] || [],
                            '벙커유': chartData[currentPeriod].bunker[bunker.name] || [],
                            'FBX': chartData[currentPeriod].container[fbx.name] || []
                        };
                        chartTitleText = '주요 지수 비교';
                        break;
                }
                
                // 차트 타이틀 업데이트
                chartTitle.textContent = chartTitleText;
                
                // 데이터셋 생성
                const datasets = [];
                const colors = [
                    'rgba(54, 162, 235, 0.5)',
                    'rgba(255, 99, 132, 0.5)',
                    'rgba(255, 206, 86, 0.5)',
                    'rgba(75, 192, 192, 0.5)',
                    'rgba(153, 102, 255, 0.5)',
                    'rgba(255, 159, 64, 0.5)'
                ];
                const borderColors = [
                    'rgba(54, 162, 235, 1)',
                    'rgba(255, 99, 132, 1)',
                    'rgba(255, 206, 86, 1)',
                    'rgba(75, 192, 192, 1)',
                    'rgba(153, 102, 255, 1)',
                    'rgba(255, 159, 64, 1)'
                ];
                
                // 데이터셋 생성
                let colorIndex = 0;
                for (const [label, values] of Object.entries(data)) {
                    datasets.push({
                        label: label,
                        data: values,
                        backgroundColor: colors[colorIndex % colors.length],
                        borderColor: borderColors[colorIndex % borderColors.length],
                        borderWidth: 2,
                        tension: 0.1
                    });
                    colorIndex++;
                }
                
                // 차트 생성
                mainChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: chartData[currentPeriod].labels,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false
                            }
                        },
                        interaction: {
                            mode: 'nearest',
                            axis: 'x',
                            intersect: false
                        }
                    }
                });
            }
            
            // 파이 차트 업데이트
            function updatePieChart() {
                const canvas = document.getElementById('pieChart');
                const ctx = canvas.getContext('2d');
                
                // 기존 차트 제거
                if (pieChart) {
                    pieChart.destroy();
                }
                
                // 차트 타입에 따른 데이터 필터링
                let filteredIndices = [];
                
                switch (currentChartType) {
                    case 'baltic':
                        filteredIndices = allIndices.filter(index => index.category === 'baltic');
                        break;
                    case 'container':
                        filteredIndices = allIndices.filter(index => index.category === 'container');
                        break;
                    case 'bunker':
                        filteredIndices = allIndices.filter(index => index.category === 'bunker');
                        break;
                    case 'port':
                        filteredIndices = allIndices.filter(index => index.category === 'port');
                        break;
                    case 'compare':
                        // 비교 차트의 경우 주요 카테고리별 데이터 분포 표시
                        const categories = ['baltic', 'container', 'bunker', 'port', 'scfi'];
                        filteredIndices = categories.map(category => {
                            const indices = allIndices.filter(index => index.category === category);
                            const total = indices.reduce((sum, index) => sum + index.numericValue, 0);
                            return {
                                name: category === 'baltic' ? 'Baltic' : 
                                      category === 'container' ? 'Container' : 
                                      category === 'bunker' ? 'Bunker' : 
                                      category === 'port' ? 'Port' : 'SCFI',
                                numericValue: total
                            };
                        });
                        break;
                }
                
                // 차트 데이터 생성
                const labels = filteredIndices.map(index => index.name);
                const data = filteredIndices.map(index => index.numericValue);
                const backgroundColors = [
                    'rgba(54, 162, 235, 0.7)',
                    'rgba(255, 99, 132, 0.7)',
                    'rgba(255, 206, 86, 0.7)',
                    'rgba(75, 192, 192, 0.7)',
                    'rgba(153, 102, 255, 0.7)',
                    'rgba(255, 159, 64, 0.7)',
                    'rgba(201, 203, 207, 0.7)'
                ];
                
                // 차트 생성
                pieChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: backgroundColors.slice(0, data.length),
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    // 길이가 너무 긴 레이블의 경우 축약
                                    generateLabels: function(chart) {
                                        const originalLabels = Chart.defaults.plugins.legend.labels.generateLabels(chart);
                                        return originalLabels.map(label => {
                                            if (label.text.length > 20) {
                                                label.text = label.text.substring(0, 20) + '...';
                                            }
                                            return label;
                                        });
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.formattedValue;
                                        return label + ': ' + value;
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            // 차트 업데이트
            function updateCharts() {
                updateMainChart();
                updatePieChart();
            }
            
            // 알림 메시지 표시
            function showAlert(message, type = 'info') {
                const alertEl = document.getElementById('statusAlert');
                const messageEl = document.getElementById('statusMessage');
                
                alertEl.className = `alert alert-${type} alert-dismissible fade show`;
                messageEl.textContent = message;
                alertEl.style.display = 'block';
            }
            
            // 알림 숨기기
            function hideAlert() {
                document.getElementById('statusAlert').style.display = 'none';
            }
            
            // 데이터 수집 실행
            async function collectData() {
                try {
                    showAlert('데이터 수집을 시작합니다...', 'info');
                    
                    const response = await fetch('/api/shipping/collect', {
                        method: 'POST',
                        headers
                    });
                    
                    if (response.status === 401 || response.status === 403) {
                        showAlert('데이터 수집 권한이 없습니다', 'danger');
                        return;
                    }
                    
                    if (!response.ok) {
                        throw new Error('데이터 수집에 실패했습니다');
                    }
                    
                    const result = await response.json();
                    showAlert(result.message, 'success');
                    
                    // 데이터 다시 로드
                    loadData();
                } catch (error) {
                    showAlert('오류: ' + error.message, 'danger');
                    console.error('데이터 수집 오류:', error);
                }
            }
            
            // 차트 이미지로 내보내기
            function exportChartAsImage() {
                // Canvas 요소 가져오기
                const mainChartCanvas = document.getElementById('mainChart');
                const pieChartCanvas = document.getElementById('pieChart');
                
                // 복합 이미지를 위한 새 Canvas 생성
                const compositeCanvas = document.createElement('canvas');
                const compositeCtx = compositeCanvas.getContext('2d');
                
                // 복합 Canvas 크기 설정
                compositeCanvas.width = mainChartCanvas.width + pieChartCanvas.width;
                compositeCanvas.height = Math.max(mainChartCanvas.height, pieChartCanvas.height);
                
                // 배경색 설정
                compositeCtx.fillStyle = '#ffffff';
                compositeCtx.fillRect(0, 0, compositeCanvas.width, compositeCanvas.height);
                
                // 차트 그리기
                compositeCtx.drawImage(mainChartCanvas, 0, 0);
                compositeCtx.drawImage(pieChartCanvas, mainChartCanvas.width, 0);
                
                // 데이터 URL 생성
                const dataURL = compositeCanvas.toDataURL('image/png');
                
                // 다운로드 링크 생성
                const link = document.createElement('a');
                link.href = dataURL;
                link.download = `shipping_data_${currentChartType}_${currentPeriod}_${new Date().toISOString().split('T')[0]}.png`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
            
            // 이벤트 리스너
            document.getElementById('refreshBtn').addEventListener('click', loadData);
            document.getElementById('collectDataBtn').addEventListener('click', collectData);
            document.getElementById('exportImageBtn').addEventListener('click', exportChartAsImage);
            document.getElementById('logoutBtn').addEventListener('click', function() {
                localStorage.removeItem('token');
                window.location.href = 'index.html';
            });
            
            // 차트 카테고리 변경 이벤트
            document.querySelectorAll('[data-chart]').forEach(button => {
                button.addEventListener('click', function() {
                    document.querySelectorAll('[data-chart]').forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    currentChartType = this.getAttribute('data-chart');
                    updateCharts();
                });
            });
            
            // 기간 변경 이벤트
            document.querySelectorAll('[data-period]').forEach(button => {
                button.addEventListener('click', function() {
                    document.querySelectorAll('[data-period]').forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    currentPeriod = this.getAttribute('data-period');
                    updateCharts();
                });
            });
            
            // 초기 데이터 로드
            loadData();
        });
    </script>
</body>
</html> 